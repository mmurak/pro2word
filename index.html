<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
    <title>Pronunciation to English Dictionary</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" >
    <link rel="shortcut icon" href="kiwi-bird.png">
    <script src="./iDict.js"></script>
</head>

<body>
<div style="text-align:right;">Powered by Carnegie Mellon University's <a href="https://github.com/cmusphinx/cmudict">CMUdict</a>.</div>
<input type="text" id="inarea" onfocus="this.select();" spellcheck="false" autocomplete="off"></input>
<input type="button" value="Search" onclick="search();"></input>
<br/>
<input type="checkbox" id="startw" checked onchange="search();">Start with
<input type="checkbox" id="endw" onchange="search();">End with
<br/>
<input type="text" id="displayfield" size="50" disabled="true"></input>
<br/>
<textarea id="outarea" rows="20" cols="40" spellcheck="false" autocomplete="off" style="font-family: Times New Roman;font-size:1.1em;background-color: white;" disabled></textarea>
<textarea id="descarea" rows="20" cols="50" style="font-family: Courier;font-size:1.0em;" disabled>
《入力方法》
  a  a     b  b     r  ɹ     @   母音全般
  {  æ     d  d     s  s     #   子音全般
  V  ʌ     D  ð     S  ʃ     1   「ア」っぽい音
  A  ɑ     f  f     Z  ʒ     2   「イ」っぽい音
  E  ɝ     g  ɡ     t  t     3   「ウ」っぽい音
  e  e     h  h     T  θ    4   「エ」っぽい音
  E  ɛ     j  j     v  v     5   「オ」っぽい音
  i  i     k  k     w  w     6   /l/, /ɹ/
  I  ɪ     l  l     z  z     7   /d/, /ð/, /z/
  o  o     m  m              8   /t/, /θ/, /s/
  O  ɔ     n  n              9   /b/, /v/
  u  u     N  ŋ              0   /m/, /n/, /ŋ/
  U  ʊ     p  p     
</textarea>

<script>
const inarea = document.getElementById("inarea");
const outarea = document.getElementById("outarea");
const startwith = document.getElementById("startw");
const endwith = document.getElementById("endw");
const displayfield = document.getElementById("displayfield");

const vowels = "[aæʌɑɝeɛiɪoɔuʊ]+";
const consonants = "[bdðfɡhjklmnŋpɹsʃʒtθvwz]+";
const asic = "[aæʌɑɝɔ]+";
const esic = "[æʌeɪɝ]+";
const isic = "[iɪj]+";
const osic = "[ʌɝɔoʊ]+";
const usic = "[uʊ]+";

const lrobfuscator = "[lɹ]";
const tTobfuscator = "[tθs]";
const dDobfuscator = "[dðz]";
const bVobfuscator = "[bv]";
const nNobfuscator = "[mnŋ]";

const prefix = "^";
const suffix = "$";

searchDict = {};
for (let [key, value] of Object.entries(iDict)) {
    let newkey = key.replaceAll("\u{0300}", "");
    newkey = newkey.replaceAll("\u{0301}", "");
    searchDict[newkey] = key;
}

const minisampa = [
    ["{", "æ"], ["V", "ʌ"], ["A", "ɑ"], ["3", "ɝ"], ["E", "ɛ"],
    ["I", "ɪ"], ["O", "ɔ"], ["U", "ʊ"], ["D", "ð"], ["N", "ŋ"],
    ["S", "ʃ"], ["Z", "ʒ"], ["T", "θ"], ["r", "ɹ"],
];

function minisampaConv(text) {
    minisampa.forEach(elem => {
        text = text.replaceAll(elem[0], elem[1]);
    });
    return text;
}

function displaySampa(text) {
    let result = "";
    let arr = text.split("");
    let i = 0;
    while(i < arr.length) {
        if (arr[i] == "!") {
            result += "!" + arr[i+1];
            i += 2;
        } else {
            result += minisampaConv(arr[i]);
            i += 1;
        }
    }
    return result;
}

function convert(text) {
    text = text.replaceAll("@", vowels);
    text = text.replaceAll("#", consonants);
    text = text.replaceAll("6", lrobfuscator);
    text = text.replaceAll("7", dDobfuscator);
    text = text.replaceAll("8", tTobfuscator);
    text = text.replaceAll("9", bVobfuscator);
    text = text.replaceAll("0", nNobfuscator);
    text = text.replaceAll("1", asic);
    text = text.replaceAll("2", isic);
    text = text.replaceAll("3", usic);
    text = text.replaceAll("4", esic);
    text = text.replaceAll("5", osic);
    text = minisampaConv(text);
    if (startwith.checked) {
        text = prefix + text;
    }
    if (endwith.checked) {
        text = text + suffix;
    }
    return text;
}

function search() {
    let target = inarea.value;
    if (target == "") {
        outarea.value = "";
        return;
    }
    inarea.disabled = true;
    target = convert(target);
    console.log(target);
    let re = new RegExp(target);
    outset = new Set();
    let candidateCount = 0;
    for (let [key, value] of Object.entries(searchDict)) {
        if (re.test(key)) {
            if (candidateCount++ > 300) {
                alert("Too many candidates...  Please change your search criteria.");
                inarea.disabled = false;
                inarea.focus();
                return;
            }
            iDict[searchDict[key]].forEach(e => {
                outset.add(e + "  /" + searchDict[key] + "/");
            });
        }
    }
    displayfield.value += " ... found " + outset.size + "entries.";
    outarea.value = "";
    Array.from(outset).sort().forEach(elem => {
        outarea.value += elem + "\n";
    });
    inarea.disabled = false;
    inarea.focus();
}

inarea.focus();
inarea.addEventListener("keypress", evt => {
    const key = evt.keyCode || evt.charCode || 0;
    if (key == 13) {
        search();
    }
});
inarea.addEventListener("input", evt => {
    displayfield.value = "/" + displaySampa(inarea.value) + "/";
});
inarea.addEventListener("blue", evt => {
    inarea.focus();
});
</script>
</body>
</html>
