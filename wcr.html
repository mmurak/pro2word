<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
	<title>Word Chain Rally</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="shortcut icon" href="kiwi-bird.png">
	<style>
		.decor{
			font-size: 100%;
		}
		@media screen and (max-width: 820px) {
			.decor{
				font-size: 200%;
			}
		}
		@media screen and (max-width: 550px) {
			.decor{
				font-size: 300%;
			}
		}
	</style>
</head>
<body>
<input type="button" class="decor" value="開始" onclick="gameStart();"></input>
<span style="float: right;">Powered by <a href="https://en.wiktionary.org/wiki/Wiktionary:Frequency_lists/English/Project_Gutenberg"  target="_blank">Project Gutenberg data（Wiktionary）</a></span>
<br/>
<label for="DISP1" class="decor">お題：</label><span id="DISP1" class="decor"></span>
<br/>
<input type="textfield" id="Court1" class="decor"></input>
<input type="button" id="PassButton" class="decor"value="パス" onclick="pass(0);" disabled></input>
<br/>
<div id="TextArea" class="decor"></div>
<script src="./Gutenberg.js"></script>
<script>
class GlobalManager {
	constructor() {
		this.displayArea = document.getElementById("DISP1");
		this.court1 = document.getElementById("Court1");
		this.passButton = document.getElementById("PassButton");
		this.tArea = document.getElementById("TextArea");
		this.counter = 0;
		this.theme = "";
		this.restriction = 2;
		this.donePool = [];
	}
}

class WordChainManager {
	constructor(wordList) {
		this.wordFinder = {};
		for (const k of wordList) {
			if (!(k.match(/^[a-zA-Z]+$/))) continue;
			let s2 = k.substr(0, G.restriction);
			if (s2.length < G.restriction) continue;
			if (!(s2 in this.wordFinder)) {
				this.wordFinder[s2] = k;
			} else {
				this.wordFinder[s2]+= ":" + k;
			}
		}
	}

	getTheWord(str) {
		const s2 = str.substr(0, G.restriction);
		const eArray = this._getEntryArray(s2);
		return eArray[Math.trunc(Math.random() * eArray.length)];
	}
	removeTheWord(str) {
		const s2 = str.substr(0, G.restriction);
		let eArray = this._getEntryArray(s2);
		const b4n = eArray.length;
		eArray = eArray.filter(n => n !== str);
		const aftN = eArray.length;
		if (aftN == 0) {
			delete this.wordFinder[s2];
		} else {
			this.wordFinder[s2] = eArray.join(":");
		}
		if (b4n != aftN) {
			return str;
		} else {
			return null;
		}
	}
	_getEntryArray(s2) {
		if (!(s2 in this.wordFinder)) {
			return [];
		}
		const entries = this.wordFinder[s2];
		return entries.split(":");
	}
	checkTheWord(str) {
		const s2 = str.substr(0, G.restriction);
		let arr = this._getEntryArray(s2);
		return arr.indexOf(str) >= 0;
	}
}

let G = new GlobalManager();
let computer;

G.displayArea.innerHTML = "";
G.court1.value = "";
G.tArea.innerHTML = "";

function gameStart() {
	computer = new WordChainManager(WordList);
	const keyArray = Object.keys(computer.wordFinder);
	let s2;
	let e2;
	let candidate;
	do {
		const sidx = Math.trunc(Math.random() * keyArray.length);
		s2 = keyArray[sidx];
		candidate = computer.getTheWord(s2);
		e2 = candidate.slice(-G.restriction);
	} while (computer._getEntryArray(e2).length <= 1);
	G.displayArea.innerHTML = e2;
	G.theme = e2;
	G.counter = 0;
	G.tArea.innerHTML = "";
	G.court1.value = "";
	computer.removeTheWord(candidate);
	G.donePool = [];
//	G.donePool.push(candidate);
	G.passButton.disabled = false;
	G.court1.focus();
}

function knuthShuffle(arr) {
	let rand;
	for (let i = arr.length - 1; i > 0; i -= 1) {
		rand = Math.floor((i + 1) * Math.random());	//get random between zero and i (inclusive)
		let temp = arr[rand];
		arr[rand] = arr[i];	//swap i (last element) with random element.
		arr[i] = temp;
	}
	return arr;
}

function pass(parm) {
	G.passButton.disabled = false;
	let eArray = computer._getEntryArray(G.theme);
	eArray = knuthShuffle(eArray);
	for (let candidate of eArray) {
		let e2 = candidate.slice(-G.restriction);
		if (computer._getEntryArray(e2).length > parm) {
			G.displayArea.innerHTML = e2;
			G.theme = e2;
			G.counter++;
			G.tArea.innerHTML = googleIt(G.counter + ".", candidate) + " " + makeLink(candidate) + "<br/>" + G.tArea.innerHTML;
			G.court1.value = "";
			computer.removeTheWord(candidate);
			G.donePool.push(candidate);
			G.court1.focus();
			return;
		}
	}
	alert("思いつきません。");
	G.court1.value = "";
	G.court1.focus();
}

function googleIt(num, word) {
	return "<a href='https://google.com/search?q=" + word + "+意味' target='_blank'>" + num + "</a>";
}

function makeLink(word) {
	return "<a href='https://ejje.weblio.jp/content/" + word + "' target='_blank'>" + word + "</a>";
}

G.court1.addEventListener("keydown", (e) => {
	if (e.key == "Enter") {
		let eWord = G.court1.value.toLowerCase();
		if (eWord == "") return;
		let s2 = eWord.substr(0, G.restriction);
		if (s2 != G.theme) {
			alert("'" + eWord + "' は '" + G.theme + "' で始まりません。");
			G.court1.value = "";
			return;
		}
		let dp = G.donePool.indexOf(eWord);
		if (dp >= 0) {
			alert("'" + eWord + "' は既に " + dp + " 番目に出てきています。");
			G.court1.value = "";
			return;
		}
		if (computer.checkTheWord(eWord)) {
			let e2 = eWord.slice(-G.restriction);
			G.displayArea.innerHTML = e2;
			G.theme = e2;
			G.counter++;
			G.tArea.innerHTML = G.counter + ". " + eWord + "<br/>" + G.tArea.innerHTML;
			computer.removeTheWord(eWord);
			G.donePool.push(eWord);
			setTimeout(pass, Math.trunc(Math.random() * 1000) + 1000, 0);
			G.passButton.disabled = true;
		} else {
			alert("この単語を知りません： '" + eWord + "'。");
		}
	}
});

window.addEventListener("focus", (e) => {
	G.court1.focus();
});

G.court1.focus();

</script>
</body>
</html>
